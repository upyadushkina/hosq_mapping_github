<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Lexend&display=swap" rel="stylesheet">
  <style>
    :root {
      --popup-bg: #262123;
      --popup-text: #E8DED3;
      --sidebar-bg: #262123;
      --sidebar-text: #E8DED3;
      --accent: #6A50FF;
    }
    * { box-sizing: border-box; }
    html, body { margin:0; height:100%; }
    body {
      background: var(--popup-bg);
      font-family: 'Lexend', sans-serif;
      color: var(--popup-text);
      overflow: hidden;
      display: grid;
      grid-template-columns: 280px 1fr;
      grid-template-rows: 100%;
    }
    /* Sidebar */
    .sidebar {
      background: var(--sidebar-bg);
      color: var(--sidebar-text);
      padding: 14px;
      overflow: auto;
      border-right: 1px solid #322C2E;
    }
    .sidebar h2 { margin: 6px 0 12px; font-size: 18px; }
    .filter-group { margin-bottom: 12px; }
    .filter-group label { display:block; font-size:12px; color:#BFB7B7; margin-bottom:6px; }
    .filter { width: 100%; padding: 6px; border-radius: 6px; border: none; background:#4C4646; color:#E8DED3; }
    .filter[multiple] { height: 80px; }
    .clear-btn {
      margin-top: 6px; width:100%; padding: 6px 10px; border:none;
      border-radius:6px; background: var(--accent); color:#fff; cursor:pointer;
    }
    /* Stage */
    .stage { position: relative; }
    svg { width: 100%; height: 100vh; cursor: grab; display:block; }
    #search-input {
      position: absolute; top: 20px; left: 20px; z-index: 100;
      padding: 6px 10px; border-radius: 6px; border: none;
      background-color: #4C4646; color: #E8DED3;
    }
    .fullscreen-btn {
      position: absolute; top: 20px; right: 20px; z-index: 100;
      padding: 6px 10px; border: none; border-radius: 6px;
      background-color: var(--accent); color: white; cursor: pointer;
    }
    .popup {
      position: absolute; background-color: var(--popup-bg); color: var(--popup-text);
      padding: 8px; border-radius: 8px; box-shadow: 0 0 12px rgba(0,0,0,0.3);
      z-index: 10; width: 220px; text-align: left; font-size: 14px; user-select: text; pointer-events: auto;
    }
    .popup img { max-width: 100%; border-radius: 6px; margin: 8px 0 4px; }
  </style>
</head>
<body>
  <aside class="sidebar">
    <h2>Filters</h2>

    <div class="filter-group">
      <label for="f_lab">Lab</label>
      <select id="f_lab" class="filter" multiple></select>
    </div>

    <div class="filter-group">
      <label for="f_department">Department</label>
      <select id="f_department" class="filter" multiple></select>
    </div>

    <div class="filter-group">
      <label for="f_discipline">Discipline</label>
      <select id="f_discipline" class="filter" multiple></select>
    </div>

    <div class="filter-group">
      <label for="f_instruments">Instruments</label>
      <select id="f_instruments" class="filter" multiple></select>
    </div>

    <div class="filter-group">
      <label for="f_skill">Skill set</label>
      <select id="f_skill" class="filter" multiple></select>
    </div>

    <button class="clear-btn" id="clearFilters">Clear filters</button>
  </aside>

  <main class="stage">
    <input id="search-input" placeholder="Search artist..." />
    <button class="fullscreen-btn" onclick="openFullscreen()">Full screen</button>
    <svg></svg>
    <div id="popup" class="popup" style="display:none;"></div>
  </main>

<script>
function openFullscreen() {
  const docElm = document.documentElement;
  if (docElm.requestFullscreen) docElm.requestFullscreen();
  else if (docElm.webkitRequestFullscreen) docElm.webkitRequestFullscreen();
  else if (docElm.msRequestFullscreen) docElm.msRequestFullscreen();
}

let data = null;
let filtered = null;

fetch('data.json')
  .then(r => r.json())
  .then(json => {
    data = json;
    filtered = computeFiltered();
    buildFiltersFromData(data);
    drawGraph(filtered);
    attachFilterHandlers();
  });

function getSelectedValues(select) {
  return Array.from(select.selectedOptions).map(o => o.value);
}
function clearMultiSelect(select) {
  Array.from(select.options).forEach(o => o.selected = false);
}

function buildFiltersFromData(data) {
  const cats = {
    "lab": new Set(),
    "department": new Set(),
    "discipline": new Set(),
    "instruments": new Set(),
    "skill set": new Set(),
  };
  data.nodes.forEach(n => {
    const t = n.type;
    if (cats[t]) cats[t].add(n.label);
  });
  const fill = (id, set) => {
    const sel = document.getElementById(id);
    sel.innerHTML = "";
    Array.from(set).sort().forEach(v => {
      const opt = document.createElement("option");
      opt.value = v; opt.textContent = v;
      sel.appendChild(opt);
    });
  };
  fill("f_lab", cats["lab"]);
  fill("f_department", cats["department"]);
  fill("f_discipline", cats["discipline"]);
  fill("f_instruments", cats["instruments"]);
  fill("f_skill", cats["skill set"]);
}

function computeFiltered() {
  // Читаем выбранные фильтры
  const selected = {
    "lab": getSelectedValues(document.getElementById("f_lab") || {selectedOptions:[]}),
    "department": getSelectedValues(document.getElementById("f_department") || {selectedOptions:[]}),
    "discipline": getSelectedValues(document.getElementById("f_discipline") || {selectedOptions:[]}),
    "instruments": getSelectedValues(document.getElementById("f_instruments") || {selectedOptions:[]}),
    "skill set": getSelectedValues(document.getElementById("f_skill") || {selectedOptions:[]}),
  };

  // Сбор удобных индексов
  const linksBySource = new Map();
  const linksByTarget = new Map();
  (data.links || []).forEach(l => {
    if (!linksBySource.has(l.source)) linksBySource.set(l.source, []);
    if (!linksByTarget.has(l.target)) linksByTarget.set(l.target, []);
    linksBySource.get(l.source).push(l.target);
    linksByTarget.get(l.target).push(l.source);
  });

  const nodeById = new Map((data.nodes || []).map(n => [n.id, n]));
  const artistIds = (data.nodes || []).filter(n => n.type === "artist").map(n => n.id);

  // проверка артиста по выбранным фильтрам
  function artistPasses(artistId) {
    for (const [cat, vals] of Object.entries(selected)) {
      if (!vals || vals.length === 0) continue;
      // формируем множество требуемых тегов (id вида `${cat}::${value}`)
      const required = new Set(vals.map(v => `${cat}::${v}`));
      // какие теги привязаны к артисту?
      const neighbors = new Set(
        (linksBySource.get(artistId) || [])
          .concat(linksByTarget.get(artistId) || [])
      );
      let ok = false;
      for (const tag of required) {
        if (neighbors.has(tag)) { ok = true; break; }
      }
      if (!ok) return false;
    }
    return true;
  }

  const visibleArtistIds = new Set(artistIds.filter(artistPasses));
  const visibleIds = new Set([...visibleArtistIds]);

  // добавим связанные узлы
  data.links.forEach(l => {
    if (visibleArtistIds.has(l.source)) visibleIds.add(l.target);
    if (visibleArtistIds.has(l.target)) visibleIds.add(l.source);
  });

  return {
    nodes: data.nodes.filter(n => visibleIds.has(n.id)),
    links: data.links.filter(l => visibleIds.has(l.source) && visibleIds.has(l.target)),
    artists: data.artists
  };
}

function attachFilterHandlers() {
  const ids = ["f_lab","f_department","f_discipline","f_instruments","f_skill"];
  ids.forEach(id => {
    const el = document.getElementById(id);
    el.addEventListener("change", () => {
      filtered = computeFiltered();
      drawGraph(filtered);
    });
  });
  document.getElementById("clearFilters").addEventListener("click", () => {
    ids.forEach(id => clearMultiSelect(document.getElementById(id)));
    filtered = computeFiltered();
    drawGraph(filtered);
  });
}

/* ===== d3 graph ===== */
let svg, g, linkSel, nodeSel, labelSel, simulation, popupNode;

function drawGraph(graph) {
  const stage = d3.select("svg");
  stage.selectAll("*").remove();
  popupNode = null;
  d3.select("#popup").style("display","none");

  svg = stage
    .call(d3.zoom().scaleExtent([0.3, 4]).on("zoom", (event) => {
      g.attr("transform", event.transform);
    }));

  const width = svg.node().clientWidth;
  const height = window.innerHeight;

  g = svg.append("g");

  simulation = d3.forceSimulation(graph.nodes)
    .force("link", d3.forceLink(graph.links).id(d => d.id).distance(80))
    .force("charge", d3.forceManyBody().strength(-100))
    .force("center", d3.forceCenter(width / 1.7, height / 4))
    .force("x", d3.forceX(width / 2).strength(0.2))
    .force("y", d3.forceY(height / 2).strength(0.2));

  linkSel = g.append("g").selectAll("line")
    .data(graph.links).enter().append("line")
    .attr("stroke", "#322C2E");

  nodeSel = g.append("g").selectAll("circle")
    .data(graph.nodes).enter().append("circle")
    .attr("r", 10)
    .attr("fill", d => d.color)
    .attr("class", "node")
    .call(drag(simulation))
    .on("mouseover", (event, d) => onHover(event, d, graph))
    .on("mouseout", (event, d) => {
      if (!popupNode || popupNode.id !== d.id) {
        d3.select("#popup").style("display","none");
      }
      nodeSel.attr("opacity", 1);
      linkSel.attr("stroke", "#322C2E").attr("opacity", 1);
    })
    .on("click", (event, d) => {
      event.stopPropagation();
      popupNode = d;

      const firstDegree = new Set();
      const secondDegree = new Set();
      graph.links.forEach(l => {
        if (l.source.id === d.id) firstDegree.add(l.target.id);
        if (l.target.id === d.id) firstDegree.add(l.source.id);
      });

      let allVisible;
      if (d.id.startsWith("artist::")) {
        graph.links.forEach(l => {
          if (firstDegree.has(l.source.id)) secondDegree.add(l.target.id);
          if (firstDegree.has(l.target.id)) secondDegree.add(l.source.id);
        });
        allVisible = new Set([d.id, ...firstDegree, ...secondDegree]);
      } else {
        allVisible = new Set([d.id, ...firstDegree]);
      }

      nodeSel.attr("display", n => allVisible.has(n.id) ? null : "none");
      linkSel.attr("display", l => allVisible.has(l.source.id) && allVisible.has(l.target.id) ? null : "none");
      labelSel.attr("display", n => allVisible.has(n.id) ? null : "none")
              .attr("opacity", n => firstDegree.has(n.id) || n.id === d.id ? 1 : 0.5);
    });

  labelSel = g.append("g").selectAll("text")
    .data(graph.nodes).enter().append("text")
    .text(d => d.label)
    .attr("font-size", 6)
    .attr("text-anchor", "middle")
    .attr("dy", 8)
    .attr("fill", "var(--popup-text)")
    .attr("pointer-events", "none")
    .style("font-family", "Lexend");

  simulation.on("tick", () => {
    linkSel
      .attr("x1", d => d.source.x).attr("y1", d => d.source.y)
      .attr("x2", d => d.target.x).attr("y2", d => d.target.y);

    nodeSel.attr("cx", d => d.x).attr("cy", d => d.y);
    labelSel.attr("x", d => d.x).attr("y", d => d.y + 8);

    if (popupNode) updatePopupPosition(popupNode);
  });

  svg.on("click", () => {
    popupNode = null;
    d3.select("#popup").style("display","none");
    nodeSel.attr("display", null).attr("opacity", 1).attr("stroke", null).attr("stroke-width", null);
    linkSel.attr("display", null).attr("stroke", "#322C2E").attr("opacity", 1);
    labelSel.attr("display", null).attr("opacity", 1);
    const searchInput = document.getElementById("search-input");
    if (searchInput) searchInput.value = "";
  });

  document.getElementById("search-input").addEventListener("input", (e) => {
    const q = e.target.value.toLowerCase();
    nodeSel.attr("stroke", d => (d.id.startsWith("artist::") && d.label.toLowerCase().includes(q)) ? "#6A50FF" : null);
    nodeSel.attr("stroke-width", d => (d.id.startsWith("artist::") && d.label.toLowerCase().includes(q)) ? 3 : null);
  });

  function drag(sim) {
    function dragstarted(event, d) { if (!event.active) sim.alphaTarget(0.3).restart(); d.fx = d.x; d.fy = d.y; }
    function dragged(event, d) { d.fx = event.x; d.fy = event.y; }
    function dragended(event, d) { if (!event.active) sim.alphaTarget(0); d.fx = null; d.fy = null; }
    return d3.drag().on("start", dragstarted).on("drag", dragged).on("end", dragended);
  }

  function onHover(event, d, graph) {
    const popup = document.getElementById("popup");
    let html = "";
    if (d.id.startsWith("artist::")) {
      const a = graph.artists[d.id];
      html = `
        <strong>${a.name}</strong><br>
        ${a.role ? `<div><span style='color: #4C4646;'>${a.role}</span></div>` : ''}
        ${a.photo ? `<img src="${a.photo}" alt="photo" onerror="this.style.display='none'">` : ''}
        ${(a.country || a.city) ? `<div><span style='color: #6A50FF;'>${a.country}${a.city ? ', ' + a.city : ''}</span></div>` : ''}
        ${a.lab ? `<div><span style='color: var(--popup-text);'>lab:</span> <span style='color: #6A50FF;'>${a.lab}</span></div>` : ''}
        ${a.department ? `<div><span style='color: var(--popup-text);'>department:</span> <span style='color: #4C4646;'>${a.department}</span></div>` : ''}
        ${a.discipline ? `<div><span style='color: var(--popup-text);'>disciplines:</span> <span style='color: #4C4646;'>${a.discipline}</span></div>` : ''}
        ${a.instruments ? `<div><span style='color: var(--popup-text);'>instruments:</span> <span style='color: #4C4646;'>${a.instruments}</span></div>` : ''}
        ${a.telegram ? `<div><span style='color: var(--popup-text);'>telegram:</span> <span style='color: #6A50FF;'>${a.telegram.replace('@', '&#64;')}</span></div>` : ''}
        ${a.email ? `<div><span style='color: var(--popup-text);'>email:</span> <span style='color: #6A50FF;'>${a.email.replace('@', '&#64;')}</span></div>` : ''}
      `;
    } else {
      html = `<div><strong>${d.label}</strong></div>`;
      const connected = new Set();
      graph.links.forEach(l => {
        if (l.source.id === d.id) connected.add(l.target.id);
        if (l.target.id === d.id) connected.add(l.source.id);
      });
      nodeSel.attr("opacity", n => connected.has(n.id) || n.id === d.id ? 1 : 0.1);
      linkSel.attr("stroke", l => (l.source.id === d.id || l.target.id === d.id) ? "#6A50FF" : "#322C2E")
             .attr("opacity", l => (l.source.id === d.id || l.target.id === d.id) ? 1 : 0.1);
    }
    popup.innerHTML = html;
    popup.style.display = "block";
    updatePopupPosition(d);
  }

  function updatePopupPosition(d) {
    const popup = document.getElementById("popup");
    const transform = d3.zoomTransform(svg.node());
    const x = d.x * transform.k + transform.x;
    const y = d.y * transform.k + transform.y;
    popup.style.left = (x + 15) + "px";
    popup.style.top = (y + 15) + "px";
  }
}
</script>
</body>
</html>
